<!doctype html>
<meta charset="utf-8">
<title>Sprites!</title>
<meta name="description" content="Pretty nifty stuff.">
<body>
<script src="../js/lib/pixi.min.js"></script>
<script src="js/lib/jsface.min.js"></script>
<script src="js/sprites/AnimatedSprite.js"></script>
<script src="js/sprites/Animations.js"></script>
<script src="js/sprites/Parts.js"></script>
<script src="js/sprites/RecolorManager.js"></script>
<script src="js/sprites/Materials.js"></script>
<script>

PIXI.SCALE_MODES.DEFAULT = PIXI.SCALE_MODES.NEAREST;

//Create the renderer
var width = 24;
var scale = 5;
var renderer = PIXI.autoDetectRenderer(800, 800);
renderer.backgroundColor = 0xffffff;

//Add the canvas to the HTML document
document.body.appendChild(renderer.view);

//Create a container object called the `stage`
var stage = new PIXI.Container();

//Tell the `renderer` to `render` the `stage`
renderer.render(stage);

PIXI.loader.add('hand', 'img/parts/hand.png');
PIXI.loader.add('handwalk0', 'img/parts/handwalk0.png');
PIXI.loader.add('handwalk1', 'img/parts/handwalk1.png');
PIXI.loader.add('handwalk2', 'img/parts/handwalk2.png');
PIXI.loader.add('handwalk3', 'img/parts/handwalk3.png');
PIXI.loader.add('foot', 'img/parts/foot.png');
PIXI.loader.add('footwalk5', 'img/parts/footwalk5.png');
PIXI.loader.add('head', 'img/parts/head.png');
PIXI.loader.add('hair', 'img/parts/hair.png');
PIXI.loader.add('hair2', 'img/parts/hair2.png');
PIXI.loader.add('body', 'img/parts/body.png');
PIXI.loader.add('bodywalk3', 'img/parts/bodywalk3.png');
PIXI.loader.add('shield', 'img/parts/shield.png');
PIXI.loader.add('shield2', 'img/parts/shield2.png');
PIXI.loader.add('sword', 'img/parts/sword.png');
PIXI.loader.add('mace', 'img/parts/mace.png');
PIXI.loader.add('staff', 'img/parts/staff.png');

PIXI.loader.load(function(loader, resources) {
    window.resources = resources;
    window.recolorManager = new RecolorManager();

    var partList = {
        head:[
            {part:Parts.Heads.Human},
            {part:Parts.Hairs.Hair1, offset:[4,-1]}
        ],
        body:[{part:Parts.Bodies.Human}],
        handleft:[{part:Parts.Shields.Shield2}],
        handright:[{part:Parts.Hands.Hand}],
        weaponright:[{part:Parts.Weapons.Sword, offset:[-2,1]}],
        footleft:[{part:Parts.Feet.Boot}],
        footright:[{part:Parts.Feet.Boot}]
    };

    var colorMap = {};
    applyMaterial(colorMap, Materials.Metals.Steel, 'rightMat');
    applyMaterial(colorMap, Materials.Metals.Steel, 'leftMat');
    applyMaterial(colorMap, Materials.Skins.Olive, 'skin');
    applyMaterial(colorMap, Materials.Hairs.Chestnut, 'hair');
    applyMaterial(colorMap, Materials.Clothing.Red, 'foot');

    var animSet = Animations.man;
    window.animSprite = new AnimatedSprite(animSet, partList, colorMap);
    animSprite.render();
    var spr = new PIXI.Sprite(animSprite.texture);
    spr.scale.x = 5;
    spr.scale.y = 5;
    stage.addChild(spr);

    setInterval(function() {
        var frame = animSprite.getFrame('walk', Date.now());
        animSprite.texture.frame = frame.rect;
        spr.x = -frame.origin[0];
        spr.y = -frame.origin[1];
        renderer.render(stage);
    },
    50);
});

function createAnimTex(animation) {
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');
    var item;
    canvas.height = width;
    canvas.width = width * animation.length;

    for (var frame = 0; frame < animation.length; frame++) {
        for (var i = 0; i < animation[frame].length; i++) {
            item = animation[frame][i];
            ctx.drawImage(resources[item.image].texture.baseTexture.source, (item.x + width*frame), item.y);
        }
    }

    return PIXI.Texture.fromCanvas(canvas);
}

</script>
</body>